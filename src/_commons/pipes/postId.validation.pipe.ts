import { Injectable, PipeTransform, ArgumentMetadata, HttpException } from "@nestjs/common"
import { Types } from "mongoose"
import { PostsService } from "../../posts/posts.service"
import { HTTP_STATUSES } from "../types/types"

//pipe проверки существования comment по id
//аналог middlewares
//вроде попроще чем Decorator
@Injectable()
export class PostIdValidatorPipe implements PipeTransform {

    constructor(private postsService: PostsService) { }

    async transform(value: any, metadata: ArgumentMetadata) {
        //если value это параметр с названием "id"
        if (metadata.type === 'param' && metadata.data === 'id') {
            if (!Types.ObjectId.isValid(value)) throw new HttpException([{ message: "not valid", field: "id" }], HTTP_STATUSES.BAD_REQUEST_400)
            const postId = value
            const post = await this.postsService.readOne(postId)
            if (!post) throw new HttpException([{ message: "post not found", field: "id" }], HTTP_STATUSES.NOT_FOUND_404)
        }
        return value
    }
    Received: { "pagesCount": 2, "page": 1, "pageSize": 10, "totalCount": 12, "items": [{ "id": "63b5a530011a17251fa2b0fb", "title": "4902post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:28.011Z", "extendedLikesInfo": {} }, { "id": "63b5a52f011a17251fa2b0f8", "title": "4901post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.747Z", "extendedLikesInfo": {} }, { "id": "63b5a52f011a17251fa2b0f5", "title": "4900post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.524Z", "extendedLikesInfo": {} }, { "id": "63b5a52f011a17251fa2b0f2", "title": "4899post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.317Z", "extendedLikesInfo": {} }, { "id": "63b5a52f011a17251fa2b0ef", "title": "4898post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.013Z", "extendedLikesInfo": {} }, { "id": "63b5a52e011a17251fa2b0ec", "title": "4897post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:26.624Z", "extendedLikesInfo": {} }, { "id": "63b5a52e011a17251fa2b0e9", "title": "4896post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:26.421Z", "extendedLikesInfo": {} }, { "id": "63b5a52e011a17251fa2b0e6", "title": "4895post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:26.203Z", "extendedLikesInfo": {} }, { "id": "63b5a52e011a17251fa2b0e3", "title": "4894post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:25.966Z", "extendedLikesInfo": {} }, { "id": "63b5a52d011a17251fa2b0e0", "title": "4893post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:25.438Z", "extendedLikesInfo": {} }] }
    Expected: { "pagesCount": 2, "page": 1, "pageSize": 10, "totalCount": 12, "items": [{ "id": "63b5a530011a17251fa2b0fb", "title": "4902post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:28.011Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52f011a17251fa2b0f8", "title": "4901post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.747Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52f011a17251fa2b0f5", "title": "4900post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.524Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52f011a17251fa2b0f2", "title": "4899post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.317Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52f011a17251fa2b0ef", "title": "4898post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:27.013Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52e011a17251fa2b0ec", "title": "4897post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:26.624Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52e011a17251fa2b0e9", "title": "4896post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:26.421Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52e011a17251fa2b0e6", "title": "4895post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:26.203Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52e011a17251fa2b0e3", "title": "4894post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:25.966Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }, { "id": "63b5a52d011a17251fa2b0e0", "title": "4893post title", "shortDescription": "description", "content": "new post content", "blogId": "63b5a52c011a17251fa2b0d7", "blogName": "new blog", "createdAt": "2023-01-04T16:11:25.438Z", "extendedLikesInfo": { "dislikesCount": 0, "likesCount": 0, "myStatus": "None", "newestLikes": [] } }] }
}
